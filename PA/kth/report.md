# 解题报告：kth
by 郑劭轩 材91 2019011852

## 算法构思
要求求取第k小的元素，容易想到用小顶堆实现的优先级队列。

由于无法直接访问`a`、`b`、`c`数组的内容，因此预先利用`compare`函数对这三者进行下标排序，原下标排序后存放在数组`_a`、`_b`、`_c`中。如此可以获知原`a`、`b`、`c`数组中的顺序情况。

结点(x,y,z)定义为下标数组`_a`、`_b`、`_c`的下标，因此结点(0,0,0)对应的(`_a[0]`,`_b[0]`,`_c[0]`)是最小目标值的数对。先将(0,0,0)插入到堆中，此后每次弹出堆顶(x,y,z)时考虑将(x+1,y,z)、(x,y+1,z)、(x,y,z+1)插入到堆中。为防止重复，只在(0,0,z)时插入(0,0,z+1)，只在(0,y,z)时插入(0,y+1,z)，每个结点都插入(x+1,y,z)，如此可以保证不重复。而且，由于下标数组已经排好序，必然有(x,y,z)对应的求和值小于(x,y,z+1)、(x,y+1,z)、(x+1,y,z)成立，进而可以推知后三者在前者出堆之前均不会成为堆顶，因而可以保证算法不出错。

## 算法实现
### 下标数组排序
下标数组的排序使用了归并排序的算法。
#### 大小比较
由于只能利用compare函数获得大小信息，以数组a为例，若要获得a内部元素的大小关系信息，可以固定选取b、c数组中的第1位元素参与比较，由此即可获得a的大小信息。
为统一接口，方便调用，我对a、b、c数组的大小比较分别实现了compare1、compare2、compare3函数，并通过函数指针调用。

### 结点类
结点类存储排序后下标数组的下标，结点的(x,y,z)与需要返回的x、y、z含义不同，需要通过下标数组进行转换。

### 小顶堆
小顶堆的实现很大程度上参考了讲义中的实现方法，功能大体上相同，因此此处不再赘述。

为方便结点的大小比较，我基于compare函数实现了方便直接比较结点的_compare函数。

## 复杂度分析

### 时间复杂度
#### 下标数组初始化
显然为$O(n)$规模

#### 排序
由于compare函数的复杂度为$O(1)$级别，因此排序算法的时间复杂度为$O(n\log n)$

#### 插入与弹出结点
记堆中结点数量为m，堆插入与删除接口的复杂度均为$O(\log m)$级别。

讨论堆中结点数量的情况：初始结点数为1，弹出一个结点后插入1~3个结点，因此第k次弹出前结点数不超过2k-1；再插入新节点时堆中结点数量不超过2k。

因此插入的总开销为
$$
I \le \sum_{i = 1}^{k}  3\log 2i = O(k\log k)
$$
删除的总开销为
$$
D \le \sum_{i = 1}^k \log{(2k-1)} = O(k\log k)
$$

均为$O(k\log k)$级别

因此总体为$O(n\log n + k\log k)$级别。
#### 封底估算
所给定的数据规模下，n不超过500000，k不超过2000000。假定每秒执行$10^9$次运算，总计算次数约为
$$
500000\log 500000 + 2000000\log 2000000 \approx 5.1\times 10^7
$$
约耗时51ms，在较大常数范围内也可满足题目给出的3s时限。由于堆的维护成本较小，常数理应不大，能够满足要求。

### 空间复杂度
#### 下标数组
$O(n)$s级别
#### 归并排序
$O(n)$级别
#### 堆
结合前段对堆中元素个数的分析，堆中的元素个数不超过2k+1，因此空间复杂度为$O(k)$级别。

#### 封底估算
综合看来为$O(n+k)$级别

下标数组与归并排序总计$4 \rm{B} \times 4n\le 8 \rm MB $
堆总计$(2k+1)\times 12\rm B \le 46 MB $

总计不超过54MB，在题目限制以内。

## 遇到的问题及解决
### 重复插入问题
在选定了算法后，主要的难点即为如何防止重复插入。由于状态空间很大而不便使用Bitmap或Hash等结构记录，只好在插入时设定一些规则防止重复插入。

经过思考后得到了实现的算法，总体上思路为：优先扩展x方向（数组a），再考虑扩展y、z方向。

## 一些关于堆内结点个数的讨论
先前对于堆内结点个数的讨论还比较粗糙，复杂度还有更精细化分析的空间。
设结点(x,y,z)，取$s = x+y+z$，可以证明，若弹出结点的$s=s_0$，堆内结点的s值只能为$s_0$或$s_0+1$。

时间关系，以下省去详细证明过程：
- 弹出结点的s值是单增的
- 每个s值对应$O(s^2)$个结点
- 堆内结点的数量应为$O(s^2)$级别（只有2种s值）
- 弹出次数k与弹出结点s的关系为
    $$k=\sum_{i=0}^{s}O(s^2)=O(s^3)$$
- 因此堆内结点数量应为$O(k^\frac{2}{3})$级别

## 参考资料
讲义：P1042 完全二叉堆